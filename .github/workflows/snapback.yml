
name: Snapback Rollback Workflow

on:
  workflow_dispatch: # Manual trigger
  push:
    branches: [ "main" ]

# Ensure GITHUB_TOKEN can create issues
permissions:
  contents: read
  issues: write

env:
  SAFE_MODE: "true"     # Dry-run by default
  AUTO_EXECUTE: "false" # Requires approval

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Scripts
        run: |
          echo "Checking rollback scripts..."
          ls scripts/ || (echo "scripts folder missing" && exit 1)

  approval:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Manual Approval Gate
        uses: trstringer/manual-approval@v1
        with:
          # Single approver (must be a collaborator with write access)
          approvers: Abhiiinaya15
          minimum-approvals: 1
          issue-title: "Approve Snapback Rollback Execution"
          issue-body: |
            > [!NOTE]
            > Workflow is pending manual review.
            > Respond "approved", "approve", "lgtm", or "yes" to continue.
            > Respond "denied", "deny", or "no" to cancel.
          secret: ${{ secrets.GITHUB_TOKEN }}

  execute-rollback:
    needs: approval
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Show execution mode
        run: |
          echo "SAFE_MODE=${SAFE_MODE}"
          echo "AUTO_EXECUTE=${AUTO_EXECUTE}"

      - name: Execute Kubernetes Rollback
        shell: bash
        run: |
          if [ "${SAFE_MODE}" = "true" ]; then
            echo "Dry-run: Would rollback Kubernetes deployment: orders-api (namespace: prod)"
          else
            ./scripts/rollback_k8s.sh orders-api prod
          fi

      - name: Execute App Service Rollback
        shell: bash
        run: |
          if [ "${SAFE_MODE}" = "true" ]; then
            echo "Dry-run: Would swap App Service slots: MyApp (staging -> production)"
          else
            ./scripts/rollback_appservice.sh MyResourceGroup MyApp staging production
          fi

      - name: Execute DB Rollback
        shell: bash
        run: |
          if [ "${SAFE_MODE}" = "true" ]; then
            echo "Dry-run: Would downgrade DB schema to revision -1"
          else
            ./scripts/rollback_db.sh -1
          fi
